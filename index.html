<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa Multipark</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/additional-styles.css">
    <link rel="stylesheet" href="css/comparison-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Scripts de bibliotecas externas -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Debug Info (s√≥ vis√≠vel no console) -->
    <div id="debug-info" style="display: none;">
        <p>Vers√£o: 2.1.0</p>
        <p>√öltima atualiza√ß√£o: 24/07/2025</p>
        <p>Debug: Ativo</p>
    </div>

    <!-- Loading inicial -->
    <div id="app-loading" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Caixa Multipark</h3>
            <p>A inicializar aplica√ß√£o...</p>
            <div id="loading-status" style="margin-top: 15px; font-size: 12px; color: #666;">
                A carregar m√≥dulos...
            </div>
        </div>
    </div>

    <!-- Aplica√ß√£o principal (oculta inicialmente) -->
    <div id="main-app" class="hidden">
        <!-- Cabe√ßalho -->
        <header class="header">
            <div class="container">
                <div class="auth-header">
                    <div class="logo">
                        <i class="fas fa-parking fa-2x"></i>
                        <h1>Caixa Multipark</h1>
                    </div>
                    <div class="user-info">
                        <span id="user-email">Carregando...</span>
                        <button class="refresh-btn" id="refresh-dashboard" title="Atualizar Dados">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="logout-btn" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
                <div class="session-info">
                    <span id="current-date">Carregando...</span>
                    <span id="last-sync">√öltima sincroniza√ß√£o: --:--</span>
                </div>
            </div>
        </header>

        <!-- Navega√ß√£o -->
        <div class="container">
            <nav class="nav-tabs">
                <div class="nav-tab active" data-tab="import">Importa√ß√£o de Arquivos</div>
                <div class="nav-tab" data-tab="compare">Compara√ß√£o Odoo vs Back Office</div>
                <div class="nav-tab" data-tab="validate">Valida√ß√£o de Caixa</div>
                <div class="nav-tab" data-tab="dashboard">Dashboard e Estat√≠sticas</div>
                <div class="nav-tab" data-tab="export">Exporta√ß√£o</div>
            </nav>

            <!-- Conte√∫do Principal -->
            <main class="main-content">
                <!-- Se√ß√£o de Importa√ß√£o de Arquivos -->
                <section id="import-section" class="content-section active">
                    <h2 class="card-title mb-20">Importa√ß√£o de Arquivos</h2>
                    
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Arquivo Odoo (Sales Orders)</h3>
                        </div>
                        <div class="card-body">
                            <div class="file-upload" id="odoo-upload">
                                <i class="fas fa-file-excel file-upload-icon"></i>
                                <p class="file-upload-text">Arraste e solte o arquivo Odoo aqui ou clique para selecionar</p>
                                <input type="file" id="odoo-file" class="hidden" accept=".xlsx, .xls">
                                <button class="btn btn-primary">Selecionar Arquivo</button>
                            </div>
                            <div id="odoo-file-info" class="hidden">
                                <p><i class="fas fa-check-circle" style="color: green;"></i> Arquivo selecionado: <span id="odoo-filename"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Arquivo Back Office (Deliveries)</h3>
                        </div>
                        <div class="card-body">
                            <div class="file-upload" id="backoffice-upload">
                                <i class="fas fa-file-excel file-upload-icon"></i>
                                <p class="file-upload-text">Arraste e solte o arquivo Back Office aqui ou clique para selecionar</p>
                                <input type="file" id="backoffice-file" class="hidden" accept=".xlsx, .xls">
                                <button class="btn btn-primary">Selecionar Arquivo</button>
                            </div>
                            <div id="backoffice-file-info" class="hidden">
                                <p><i class="fas fa-check-circle" style="color: green;"></i> Arquivo selecionado: <span id="backoffice-filename"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-center mt-20">
                        <button id="process-files-btn" class="btn btn-primary" disabled>Processar Arquivos</button>
                    </div>
                </section>

                <!-- Se√ß√£o de Compara√ß√£o Odoo vs Back Office -->
                <section id="compare-section" class="content-section">
                    <h2 class="card-title mb-20">Compara√ß√£o Odoo vs Back Office</h2>
                    
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Resumo da Compara√ß√£o</h3>
                        </div>
                        <div class="card-body">
                            <div class="flex flex-between mb-10">
                                <div>
                                    <p>Total de registros no Odoo: <strong id="odoo-count">0</strong></p>
                                    <p>Total de registros no Back Office: <strong id="backoffice-count">0</strong></p>
                                </div>
                                <div>
                                    <p>Registros com inconsist√™ncias: <strong id="inconsistency-count" class="status-error">0</strong></p>
                                    <p>Registros ausentes: <strong id="missing-count" class="status-warning">0</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Registros</h3>
                            <div>
                                <button class="btn btn-secondary active" id="show-all-btn">Todos</button>
                                <button class="btn btn-warning" id="show-missing-btn">Ausentes</button>
                                <button class="btn btn-danger" id="show-inconsistent-btn">Inconsistentes</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Matr√≠cula</th>
                                        <th>Aloca√ß√£o</th>
                                        <th>Pre√ßo Booking (BO)</th>
                                        <th>Pre√ßo Booking (Odoo)</th>
                                        <th>Marca</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">Nenhum dado dispon√≠vel. Importe os arquivos primeiro.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex flex-center mt-20">
                        <button id="validate-comparison-btn" class="btn btn-primary" disabled>Validar e Avan√ßar</button>
                    </div>
                </section>

                <!-- Se√ß√£o de Valida√ß√£o de Caixa -->
                <section id="validate-section" class="content-section">
                    <h2 class="card-title mb-20">Valida√ß√£o de Caixa</h2>
                    
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Arquivo de Caixa</h3>
                        </div>
                        <div class="card-body">
                            <div class="file-upload" id="caixa-upload">
                                <i class="fas fa-file-excel file-upload-icon"></i>
                                <p class="file-upload-text">Arraste e solte o arquivo de Caixa aqui ou clique para selecionar</p>
                                <input type="file" id="caixa-file" class="hidden" accept=".xlsx, .xls">
                                <button class="btn btn-primary">Selecionar Arquivo</button>
                            </div>
                            <div id="caixa-file-info" class="hidden">
                                <p><i class="fas fa-check-circle" style="color: green;"></i> Arquivo selecionado: <span id="caixa-filename"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-20 hidden" id="driver-selection">
                        <div class="card-header">
                            <h3 class="card-title">Selecionar Condutor</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="driver-select" class="form-label">Condutor:</label>
                                <select id="driver-select" class="form-control">
                                    <option value="">Selecione um condutor</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card hidden" id="driver-deliveries">
                        <div class="card-header">
                            <h3 class="card-title">Entregas do Condutor</h3>
                            <div id="driver-summary">
                                <p>Total de entregas: <strong id="delivery-count">0</strong></p>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="deliveries-table">
                                <thead>
                                    <tr>
                                        <th>Aloca√ß√£o</th>
                                        <th>Matr√≠cula</th>
                                        <th>Data Checkout</th>
                                        <th>M√©todo Pagamento</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex flex-between mt-20">
                        <button id="add-caixa-btn" class="btn btn-secondary hidden">Adicionar Nova Folha de Caixa</button>
                        <button id="close-caixa-btn" class="btn btn-primary hidden">Encerrar Caixa</button>
                    </div>
                </section>

                <!-- Se√ß√£o de Dashboard e Estat√≠sticas -->
                <section id="dashboard-section" class="content-section">
                    <h2 class="card-title mb-20">Dashboard e Estat√≠sticas</h2>
                    
                    <!-- Card para estat√≠sticas de entregas efetuadas vs previstas -->
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Entregas Efetuadas vs Previstas</h3>
                        </div>
                        <div class="card-body">
                            <div class="flex flex-between">
                                <div>
                                    <p>Entregas Efetuadas: <strong id="entregas-efetuadas">0</strong></p>
                                    <p>Entregas Previstas: <strong id="entregas-previstas">0</strong></p>
                                </div>
                                <div>
                                    <p>Percentual de Conclus√£o: <strong id="percentual-entregas" class="status-warning">0%</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-between mb-20">
                        <div class="card" style="width: 32%;">
                            <div class="card-header">
                                <h3 class="card-title">Resumo da Caixa</h3>
                            </div>
                            <div class="card-body">
                                <p>Total da Caixa: <strong id="total-caixa">0,00 ‚Ç¨</strong></p>
                                <p>Total em Numer√°rio: <strong id="total-numerario">0,00 ‚Ç¨</strong></p>
                                <p>Total em Multibanco: <strong id="total-multibanco">0,00 ‚Ç¨</strong></p>
                                <p>Total No Pay: <strong id="total-nopay">0,00 ‚Ç¨</strong></p>
                                <p>Total Online: <strong id="total-online">0,00 ‚Ç¨</strong></p>
                            </div>
                        </div>
                        
                        <div class="card" style="width: 32%;">
                            <div class="card-header">
                                <h3 class="card-title">Entregas por M√©todo</h3>
                            </div>
                            <div class="card-body">
                                <p>Entregas em Numer√°rio: <strong id="count-numerario">0</strong></p>
                                <p>Entregas em Multibanco: <strong id="count-multibanco">0</strong></p>
                                <p>Entregas No Pay: <strong id="count-nopay">0</strong></p>
                                <p>Entregas Online: <strong id="count-online">0</strong></p>
                                <p>Total de Entregas: <strong id="count-total">0</strong></p>
                            </div>
                        </div>
                        
                        <div class="card" style="width: 32%;">
                            <div class="card-header">
                                <h3 class="card-title">Comparativo</h3>
                            </div>
                            <div class="card-body">
                                <p>Caixa Prevista (BO): <strong id="previsto-bo">0,00 ‚Ç¨</strong></p>
                                <p>Caixa Prevista (Odoo): <strong id="previsto-odoo">0,00 ‚Ç¨</strong></p>
                                <p>Caixa Efetiva: <strong id="efetiva-caixa">0,00 ‚Ç¨</strong></p>
                                <p>Diferen√ßa: <strong id="diferenca-caixa">0,00 ‚Ç¨</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card para estat√≠sticas por condutor -->
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Estat√≠sticas por Condutor</h3>
                        </div>
                        <div class="card-body">
                            <div id="condutor-stats-container">
                                <p class="text-center">A carregar estat√≠sticas...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Gr√°ficos</h3>
                        </div>
                        <div class="card-body flex flex-between">
                            <div style="width: 48%;">
                                <canvas id="chart-brands"></canvas>
                            </div>
                            <div style="width: 48%;">
                                <canvas id="chart-payments"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Todas as Entregas</h3>
                        </div>
                        <div class="table-container">
                            <table class="table" id="all-deliveries-table">
                                <thead>
                                    <tr>
                                        <th>Matr√≠cula</th>
                                        <th>Data</th>
                                        <th>Marca</th>
                                        <th>M√©todo Pagamento</th>
                                        <th>Valor</th>
                                        <th>Condutor</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Se√ß√£o de Exporta√ß√£o -->
                <section id="export-section" class="content-section">
                    <h2 class="card-title mb-20">Exporta√ß√£o</h2>
                    
                    <div class="card mb-20">
                        <div class="card-header">
                            <h3 class="card-title">Exportar Dados</h3>
                        </div>
                        <div class="card-body">
                            <p>Exporte os dados processados para um arquivo Excel.</p>
                            <div class="flex flex-center mt-20">
                                <button id="export-btn" class="btn btn-primary">Exportar para Excel</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Hist√≥rico de Exporta√ß√µes</h3>
                        </div>
                        <div class="card-body">
                            <div id="export-history">
                                <p class="text-center">A carregar hist√≥rico...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Status de conex√£o -->
    <div id="connection-status" class="connection-status connected">
        <i class="fas fa-wifi"></i> Conectado ao Supabase
    </div>

    <!-- Modais -->
    <div class="modal-overlay" id="details-modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Detalhes do Registro</h3>
                <button class="modal-close" onclick="document.getElementById('details-modal-overlay').style.display = 'none';">&times;</button>
            </div>
            <div class="modal-body" id="details-modal-body"></div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Resolver Problema</h3>
                <button class="modal-close" onclick="document.getElementById('edit-modal-overlay').style.display = 'none';">&times;</button>
            </div>
            <div class="modal-body" id="edit-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-resolution-btn">Salvar</button>
                <button class="btn btn-secondary" onclick="document.getElementById('edit-modal-overlay').style.display = 'none';">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="validate-modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Validar Entrega</h3>
                <button class="modal-close" onclick="document.getElementById('validate-modal-overlay').style.display = 'none';">&times;</button>
            </div>
            <div class="modal-body" id="validate-modal-body"></div>
        </div>
    </div>

    <!-- Scripts da aplica√ß√£o na ordem correta para inicializa√ß√£o -->
    <!-- 1. Sistema de debug primeiro (para diagnosticar problemas) -->
    <script src="js/debug-system.js"></script>
    
    <!-- 2. Configura√ß√£o e utilit√°rios -->
    <script src="js/config.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/notifications.js"></script>
    
    <!-- 3. Integra√ß√£o Supabase -->
    <script src="js/supabase-integration.js"></script>
    
    <!-- 4. Sistemas principais -->
    <script src="js/file-processor.js"></script>
    <script src="js/comparison-system.js"></script>
    <script src="js/validation-system.js"></script>
    <script src="js/dashboard.js"></script>
    
    <!-- 5. Aplica√ß√£o principal por √∫ltimo -->
    <script src="js/app.js"></script>
    
    <!-- Script inline para mostrar progresso de carregamento -->
    <script>
        // Atualizar status de carregamento
        document.addEventListener('DOMContentLoaded', () => {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) {
                let step = 0;
                const steps = [
                    'A carregar configura√ß√µes...',
                    'A conectar ao Supabase...',
                    'A inicializar m√≥dulos...',
                    'A verificar sistema...',
                    'A finalizar...'
                ];
                
                const updateStatus = () => {
                    if (step < steps.length) {
                        statusEl.textContent = steps[step];
                        step++;
                        setTimeout(updateStatus, 800);
                    } else {
                        statusEl.textContent = 'Sistema pronto!';
                    }
                };
                
                setTimeout(updateStatus, 500);
            }
        });

        // Debug quick access
        window.addEventListener('keydown', (e) => {
            // Ctrl+Shift+D para debug r√°pido
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                console.log('üîç Executando diagn√≥stico r√°pido...');
                if (window.quickCheck) {
                    window.quickCheck();
                } else {
                    console.log('‚ùå Sistema de debug n√£o dispon√≠vel');
                }
            }
        });
    </script>
</body>
</html>